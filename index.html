<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Royal Wunderkind Model School ‚Äì Result</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --purple: #8a168a;
  --light-purple: #d38ad3;
  --border: #8a168a;
  --text: #222;
}
body {
  font-family: Arial, Helvetica, sans-serif;
  margin: 0;
  background: #f7f7f7;
  color: var(--text);
}
.container {
  max-width: 1200px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border: 2px solid var(--border);
  border-radius: 12px;
  overflow-x: auto;
}
h1, h2, h3, .section-title {
  text-align: center;
  margin: 6px 0;
}
.school-header {
  display: flex;
  align-items: center;
  gap: 15px;
  border-bottom: 4px solid var(--purple);
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.school-logo {
  width: 80px;
  height: 80px;
  border: 1px dashed #999;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  overflow: hidden;
  flex-shrink: 0;
  position: relative;
}
.school-logo img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}
.clear-btn {
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(255,0,0,0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  cursor: pointer;
  display: none;
}
.school-logo:hover .clear-btn, .signature-upload:hover .clear-btn {
  display: block;
}
.school-info {
  flex: 1;
  text-align: center;
}
.school-header h1 {
  color: var(--purple);
  font-size: 22px;
  margin: 0;
}
.school-header p {
  margin: 2px 0;
  font-size: 14px;
}
.contact-line {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 13px;
}
.contact-line i {
  font-size: 16px;
  width: 20px;
  text-align: center;
}
.contact-line .icon-wrapper {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
}
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
  align-items: center;
}
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}
label {
  font-size: 13px;
  font-weight: bold;
  display: block;
}
input, select, textarea {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  border: 1px solid #999;
  border-radius: 4px;
  box-sizing: border-box;
}
textarea {
  min-height: 80px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
  font-size: 13px;
}
th, td {
  border: 1px solid var(--border);
  padding: 8px;
  text-align: center;
  word-wrap: break-word;
}
th {
  background: var(--purple);
  color: #fff;
  font-size: 12px;
}
td input, td select {
  border: none;
  text-align: center;
  width: 100%;
  background: transparent;
}
.section-title {
  background: var(--purple);
  color: #fff;
  padding: 8px;
  margin-top: 20px;
  font-weight: bold;
}
.two-col {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}
@media (min-width: 768px) {
  .two-col {
    grid-template-columns: 1fr 1fr;
  }
}
.summary-box {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin: 20px 0;
  padding: 15px;
  background: #f0f0f0;
  border-radius: 8px;
  font-weight: bold;
}
.summary-box div {
  text-align: center;
}
.footer {
  display: grid;
  grid-template-columns: 1fr;
  margin-top: 30px;
  gap: 40px;
}
@media (min-width: 768px) {
  .footer {
    grid-template-columns: 1fr 1fr;
  }
}
.footer div {
  border-top: 1px solid #000;
  text-align: center;
  padding-top: 6px;
  font-size: 13px;
}
.signature-upload {
  width: 100%;
  height: 120px;
  border: 1px dashed #999;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  overflow: hidden;
  background: #f9f9f9;
  position: relative;
}
.signature-upload img {
  max-width: 90%;
  max-height: 100%;
  object-fit: contain;
}
.table-wrapper {
  overflow-x: auto;
}
button.small-btn, button.print-btn, button.save-btn, button.load-btn, button.generate-btn, button.clear-all-btn, button.backup-btn, button.restore-btn, button.calc-class-avg {
  padding: 8px 16px;
  margin: 5px 0;
  font-size: 14px;
  cursor: pointer;
  background: var(--purple);
  color: white;
  border: none;
  border-radius: 6px;
}
button.generate-btn { background: #17a2b8; }
button.clear-all-btn { background: #dc3545; }
button.backup-btn { background: #28a745; }
button.restore-btn { background: #ffc107; color: #212529; }
button.calc-class-avg { background: #fd7e14; }
button.print-btn {
  background: #28a745;
}
button.save-btn {
  background: #007bff;
}
button.load-btn {
  background: #6c757d;
}
.auto-save-notice {
  text-align: center;
  font-size: 12px;
  color: green;
  margin: 10px 0;
  min-height: 20px;
}
.extra-controls, .class-avg-section {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin: 20px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}
.class-avg-result {
  width: 100%;
  margin-top: 15px;
  padding: 15px;
  background: #e9ecef;
  border-radius: 8px;
  display: none;
}
.class-avg-result table {
  margin: 10px 0;
  font-size: 13px;
}
.class-avg-result th {
  background: var(--purple);
}
.term-display {
  text-align: center;
  font-weight: bold;
  font-size: 16px;
  margin: 15px 0;
  color: var(--purple);
}
/* Print Styles */
@media print {
  @page {
    size: A4;
    margin: 10mm;
  }
  body, .container {
    background: white;
    margin: 0;
    padding: 12mm;
  }
  .controls, .small-btn, .print-btn, .auto-save-notice, .clear-btn, .summary-box, .extra-controls, .class-avg-section, .table-wrapper button {
    display: none !important;
  }
  .school-logo {
    width: 90px;
    height: 90px;
  }
  .info-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
    font-size: 10pt;
  }
  table {
    font-size: 8pt !important; /* Reduced for better fit */
  }
  th, td {
    padding: 3px 4px !important;
    border: 1px solid #000 !important;
    white-space: nowrap;
    overflow: visible;
  }
  th {
    font-size: 8pt;
  }
  /* Ensure Total, Grade, Remark are visible and readable */
  table#resultTable th:nth-child(6),
  table#resultTable th:nth-child(7),
  table#resultTable th:nth-child(8),
  table#resultTable td:nth-child(6),
  table#resultTable td:nth-child(7),
  table#resultTable td:nth-child(8) {
    min-width: 60px !important;
    font-size: 8pt !important;
  }
  /* Hide Action column in print */
  table#resultTable th:nth-child(9),
  table#resultTable td:nth-child(9) {
    display: none;
  }
  .section-title {
    padding: 4px;
    font-size: 10pt;
  }
  .two-col, .footer {
    grid-template-columns: 1fr 1fr;
  }
  .signature-upload {
    height: 60px;
  }
  input, select, textarea {
    border: none !important;
    background: transparent !important;
    font-size: 9pt !important;
  }
  select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    color: #000;
  }
  .term-display {
    display: block !important;
    page-break-inside: avoid;
  }
  .contact-line {
    align-items: baseline;
  }
  .contact-line .icon-wrapper {
    padding-top: 2px;
  }
}
/* Mobile */
@media (max-width: 767px) {
  .school-header {
    flex-direction: column;
    text-align: center;
  }
  .controls, .extra-controls, .class-avg-section {
    flex-direction: column;
  }
  button {
    width: 100%;
  }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
  <!-- School Header -->
  <div class="school-header">
    <div class="school-logo" onclick="document.getElementById('logoInput').click()">
      <span style="color:#999;">Upload Logo</span>
      <button class="clear-btn" onclick="clearImage(event, 'school-logo', STORAGE_KEY_LOGO)">√ó</button>
    </div>
    <input type="file" id="logoInput" style="display:none" accept="image/*" onchange="previewLogo(event)">
    <div class="school-info">
      <h1 contenteditable="true" id="schoolName">ROYAL WUNDERKIND MODEL SCHOOL</h1>
      <p contenteditable="true" id="schoolMotto">Partnering with Christ for a better world</p>
      <div class="contact-line"><span class="icon-wrapper"><i class="fas fa-map-marker-alt"></i></span> <span contenteditable="true" id="schoolAddress">Beside Solar House, Close to colony 3 Hostel, Jalala GRA, Tanke Oke-odo, Ilorin, Kwara state.</span></div>
      <div class="contact-line"><span class="icon-wrapper"><i class="fas fa-phone"></i></span> <span contenteditable="true" id="schoolPhone">08142856970, 09012521178</span></div>
      <div class="contact-line"><span class="icon-wrapper"><i class="fas fa-envelope"></i></span> <span contenteditable="true" id="schoolEmail">royalwunderkindmodelschool@gmail.com</span></div>
      <div class="contact-line"><span class="icon-wrapper"><i class="fas fa-globe"></i></span> <span contenteditable="true" id="schoolWebsite">www.royalwunderkindmodelschools.com</span></div>
    </div>
  </div>
  <!-- RESULT TAB -->
  <div id="result">
    <div class="controls">
      <select id="classForID">
        <option value="">-- Select Class --</option>
        <optgroup label="Preschool">
          <option value="RWPRS01">RWPRS 01</option>
        </optgroup>
        <optgroup label="Primary">
          <option value="RWMSPR001">RWMSPR 001</option>
          <option value="RWMSPR002">RWMSPR 002</option>
          <option value="RWMSPR003">RWMSPR 003</option>
          <option value="RWMSPR004">RWMSPR 004</option>
          <option value="RWMSPR005">RWMSPR 005</option>
        </optgroup>
        <optgroup label="Junior Secondary">
          <option value="RWMJSS1">RWMJSS 1</option>
          <option value="RWMJSS2">RWMJSS 2</option>
          <option value="RWMJSS3">RWMJSS 3</option>
        </optgroup>
        <optgroup label="Senior Secondary">
          <option value="RWMSSS1">RWMS SS1</option>
          <option value="RWMSSS2">RWMS SS2</option>
          <option value="RWMSSS3">RWMS SS3</option>
        </optgroup>
      </select>
      <button onclick="generateStudentID()" class="generate-btn">Generate Student ID</button>
      <input type="text" id="studentID" placeholder="Student ID (e.g. RWPRS01-001)" style="width:220px;">
      <button onclick="saveStudentResult()" class="save-btn">üíæ Save & New</button>
      <button onclick="loadStudentResult()" class="load-btn">üìÇ Load Result</button>
      <select id="termSelect" style="padding:8px;">
        <option>1st Term</option>
        <option>2nd Term</option>
        <option>3rd Term</option>
      </select>
      <button onclick="window.print()" class="print-btn">üñ®Ô∏è Print Result</button>
    </div>
    <!-- Term Display for Print -->
    <div class="term-display" id="termDisplay" style="display:none;"></div>
    <div class="info-grid">
      <div><label>Name<input id="resultName"></label></div>
      <div><label>Admission No<input id="resultAdmNo"></label></div>
      <div><label>Class<input id="resultClass"></label></div>
      <div><label>No. in Class<input id="resultNoInClass" placeholder="e.g. 30"></label></div>
      <div><label>Times Present<input id="resultPresent"></label></div>
      <div><label>Times Absent<input id="resultAbsent"></label></div>
    </div>
    <div class="table-wrapper">
      <table id="resultTable">
        <thead>
          <tr>
            <th>Subject</th>
            <th>CA1 (15)</th>
            <th>CA2 (15)</th>
            <th>HW (10)</th>
            <th>Exam (60)</th>
            <th>Total</th>
            <th>Grade</th>
            <th>Remark</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr style="font-weight:bold; background:#f0f0f0;">
            <td>Total Score</td>
            <td colspan="4"></td>
            <td><input id="grandTotal" readonly style="font-weight:bold;"></td>
            <td colspan="3"></td>
          </tr>
          <tr style="font-weight:bold; background:#e0e0e0;">
            <td>Average</td>
            <td colspan="4"></td>
            <td><input id="classAverage" readonly style="font-weight:bold;"></td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
      <button onclick="addSubject()" class="small-btn">Add Subject</button>
    </div>
    <div class="summary-box">
      <div>Total Obtainable: <span id="totalPossible">0</span></div>
      <div>Total Score: <span id="totalScoreDisplay">0</span></div>
      <div>Average: <span id="averageDisplay">0</span></div>
      <div>Position: <input id="positionInClass" readonly placeholder="e.g. 1st" style="width:100px; font-weight:bold;"></div>
    </div>
    <div class="two-col">
      <div>
        <div class="section-title">Psychomotor Skills</div>
        <table>
          <tr><td>Handling of Tools</td><td><input id="psycho1"></td></tr>
          <tr><td>Verbal Fluency</td><td><input id="psycho2"></td></tr>
        </table>
      </div>
      <div>
        <div class="section-title">Affective Skills</div>
        <table>
          <tr><td>Cooperation</td><td><input id="affect1"></td></tr>
          <tr><td>Punctuality</td><td><input id="affect2"></td></tr>
          <tr><td>Reading</td><td><input id="affect3"></td></tr>
          <tr><td>Clean & Orderly</td><td><input id="affect4"></td></tr>
        </table>
      </div>
    </div>
    <div class="section-title">Teacher's Comment</div>
    <textarea id="teacherComment"></textarea>
    <div class="footer">
      <div>
        <strong>Class Teacher's Signature</strong>
        <div class="signature-upload" onclick="document.getElementById('classSigInput').click()">
          <span style="color:#999;">Click to upload</span>
          <button class="clear-btn" onclick="clearImage(event, this.parentElement, STORAGE_KEY_SIG_CLASS)">√ó</button>
        </div>
        <input type="file" id="classSigInput" style="display:none" accept="image/*" onchange="previewSignature(event, this)">
      </div>
      <div>
        <strong>Head Teacher's Signature</strong>
        <div class="signature-upload" onclick="document.getElementById('headSigInput').click()">
          <span style="color:#999;">Click to upload</span>
          <button class="clear-btn" onclick="clearImage(event, this.parentElement, STORAGE_KEY_SIG_HEAD)">√ó</button>
        </div>
        <input type="file" id="headSigInput" style="display:none" accept="image/*" onchange="previewSignature(event, this)">
      </div>
    </div>
  </div>
  <!-- Extra Controls -->
  <div class="extra-controls">
    <button onclick="clearAllData()" class="clear-all-btn">üóëÔ∏è Clear All Saved Data</button>
    <button onclick="backupData()" class="backup-btn">üíæ Backup Data (Download)</button>
    <button onclick="document.getElementById('restoreInput').click()" class="restore-btn">üìÇ Restore Data</button>
    <input type="file" id="restoreInput" style="display:none" accept=".json" onchange="restoreData(event)">
  </div>
  <!-- Class Average Calculation Section -->
  <div class="class-avg-section">
    <h3 style="width:100%; margin:0 0 10px;">Class Average Calculation</h3>
    <input type="text" id="classCodeInput" placeholder="Enter Class Code (e.g. RWMJSS1, RWPRS01)" style="width:250px;">
    <button onclick="calculateClassAverage()" class="calc-class-avg">Calculate Class Average</button>
    <div id="classAvgResult" class="class-avg-result">
      <strong id="classAvgSummary"></strong>
      <table id="classAvgTable">
        <thead>
          <tr><th>Student ID</th><th>Name</th><th>Average</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="auto-save-notice" id="autoSaveNotice"></div>
</div>
<script>
const STORAGE_KEY_LOGO = 'schoolLogo';
const STORAGE_KEY_SIG_CLASS = 'sigClass';
const STORAGE_KEY_SIG_HEAD = 'sigHead';
const STORAGE_KEY_SCHOOL_INFO = 'schoolHeaderInfo';
const STORAGE_KEY_COUNTERS = 'studentIdCounters';
const subjectsList = [
  "--Select subject--",
  "English",
  "Mathematics",
  "CRS",
  "IT",
  "Social Studies",
  "Elementary Science",
  "Digital Art"
];
let autoSaveInterval = null;
let lastSavedResultData = null;

function showAutoSave(message = "Auto-saved") {
  const notice = document.getElementById('autoSaveNotice');
  notice.textContent = message + " at " + new Date().toLocaleTimeString();
  clearTimeout(notice.hideTimer);
  notice.hideTimer = setTimeout(() => notice.textContent = '', 3000);
}

function updateTermDisplay() {
  const term = document.getElementById('termSelect').value;
  document.getElementById('termDisplay').textContent = term + " Result";
}
document.getElementById('termSelect').addEventListener('change', updateTermDisplay);

function startAutoSave() {
  if (autoSaveInterval) clearInterval(autoSaveInterval);
  autoSaveInterval = setInterval(() => {
    const studentID = document.getElementById('studentID').value.trim();
    if (studentID) {
      const currentData = JSON.stringify(getCurrentResultData());
      if (currentData !== lastSavedResultData) {
        localStorage.setItem(`result_${studentID}`, currentData);
        lastSavedResultData = currentData;
        showAutoSave("Result auto-saved");
      }
    }
  }, 10000);
}

function generateStudentID() {
  const classCode = document.getElementById('classForID').value;
  if (!classCode) {
    alert("Please select a class first.");
    return;
  }
  let counters = JSON.parse(localStorage.getItem(STORAGE_KEY_COUNTERS) || '{}');
  if (!counters[classCode]) counters[classCode] = 0;
  counters[classCode]++;
  localStorage.setItem(STORAGE_KEY_COUNTERS, JSON.stringify(counters));
  const seq = String(counters[classCode]).padStart(3, '0');
  const studentID = `${classCode}-${seq}`;
  document.getElementById('studentID').value = studentID;
  const classMap = {
    'RWPRS01': 'Preschool 01',
    'RWMSPR001': 'Primary 1', 'RWMSPR002': 'Primary 2', 'RWMSPR003': 'Primary 3',
    'RWMSPR004': 'Primary 4', 'RWMSPR005': 'Primary 5',
    'RWMJSS1': 'JSS 1', 'RWMJSS2': 'JSS 2', 'RWMJSS3': 'JSS 3',
    'RWMSSS1': 'SS 1', 'RWMSSS2': 'SS 2', 'RWMSSS3': 'SS 3'
  };
  document.getElementById('resultClass').value = classMap[classCode] || classCode;
}

function calculateClassAverage() {
  const classCode = document.getElementById('classCodeInput').value.trim().toUpperCase();
  if (!classCode) {
    alert("Please enter a class code.");
    return;
  }

  const allKeys = Object.keys(localStorage);
  const results = [];
  let totalAvg = 0;
  let count = 0;

  allKeys.forEach(key => {
    if (key.startsWith('result_')) {
      const studentID = key.substring(7);
      if (studentID.startsWith(classCode + '-')) {
        try {
          const data = JSON.parse(localStorage.getItem(key));
          const avg = parseFloat(data.classAverage || 0);
          if (!isNaN(avg) && data.name) {
            results.push({ id: studentID, name: data.name, avg: avg });
            totalAvg += avg;
            count++;
          }
        } catch (e) {}
      }
    }
  });

  results.sort((a, b) => b.avg - a.avg);

  const tbody = document.querySelector('#classAvgTable tbody');
  tbody.innerHTML = '';

  if (results.length === 0) {
    document.getElementById('classAvgSummary').textContent = 'No results found for this class.';
    document.getElementById('classAvgResult').style.display = 'block';
    return;
  }

  results.forEach((res, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${res.id}</td>
      <td>${res.name || '(No name)'}</td>
      <td>${res.avg.toFixed(2)}</td>
      <td><button onclick="deleteStudentResult('${res.id}', this)" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">√ó</button></td>
    `;
    tbody.appendChild(tr);
  });

  const classAverage = (totalAvg / count).toFixed(2);
  document.getElementById('classAvgSummary').textContent = `Class Average: ${classAverage} (${results.length} students)`;
  document.getElementById('classAvgResult').style.display = 'block';
}

function deleteStudentResult(studentID, btn) {
  if (confirm(`Delete result for ${studentID}? This cannot be undone.`)) {
    localStorage.removeItem(`result_${studentID}`);
    btn.closest('tr').remove();
    calculateClassAverage(); // refresh summary
  }
}

function backupData() {
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    data[key] = localStorage.getItem(key);
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'royal-wunderkind-backup-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function restoreData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      Object.keys(data).forEach(key => {
        localStorage.setItem(key, data[key]);
      });
      alert('Data restored successfully! Page will reload.');
      location.reload();
    } catch (err) {
      alert('Invalid backup file.');
    }
  };
  reader.readAsText(file);
}

function clearAllData() {
  if (confirm('Delete ALL saved data (results, logo, signatures, counters)? This cannot be undone.')) {
    localStorage.clear();
    alert('All data cleared.');
    location.reload();
  }
}

function saveSchoolHeader() {
  const info = {
    name: document.getElementById('schoolName').textContent,
    motto: document.getElementById('schoolMotto').textContent,
    address: document.getElementById('schoolAddress').textContent,
    phone: document.getElementById('schoolPhone').textContent,
    email: document.getElementById('schoolEmail').textContent,
    website: document.getElementById('schoolWebsite').textContent
  };
  localStorage.setItem(STORAGE_KEY_SCHOOL_INFO, JSON.stringify(info));
}

function loadSchoolHeader() {
  const saved = localStorage.getItem(STORAGE_KEY_SCHOOL_INFO);
  if (saved) {
    const info = JSON.parse(saved);
    document.getElementById('schoolName').textContent = info.name || 'ROYAL WUNDERKIND MODEL SCHOOL';
    document.getElementById('schoolMotto').textContent = info.motto || 'Partnering with Christ for a better world';
    document.getElementById('schoolAddress').textContent = info.address || '';
    document.getElementById('schoolPhone').textContent = info.phone || '';
    document.getElementById('schoolEmail').textContent = info.email || '';
    document.getElementById('schoolWebsite').textContent = info.website || '';
  }
}

['schoolName','schoolMotto','schoolAddress','schoolPhone','schoolEmail','schoolWebsite'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('blur', saveSchoolHeader);
});

function clearResultForm() {
  document.getElementById('studentID').value = '';
  document.getElementById('resultName').value = '';
  document.getElementById('resultAdmNo').value = '';
  document.getElementById('resultClass').value = '';
  document.getElementById('resultNoInClass').value = '';
  document.getElementById('resultPresent').value = '';
  document.getElementById('resultAbsent').value = '';
  document.getElementById('teacherComment').value = '';
  document.getElementById('positionInClass').value = '';
  document.querySelector('#resultTable tbody').innerHTML = '';
  addSubjectRow();
  calculateGrades();
}

function saveStudentResult() {
  const studentID = document.getElementById('studentID').value.trim();
  if (!studentID) {
    alert('Please generate or enter a Student ID first.');
    return;
  }
  const data = getCurrentResultData();
  localStorage.setItem(`result_${studentID}`, JSON.stringify(data));
  showAutoSave("Manually saved");
  clearResultForm();
}

function loadStudentResult() {
  const studentID = document.getElementById('studentID').value.trim();
  if (!studentID) {
    alert('Please enter a Student ID to load.');
    return;
  }
  const saved = localStorage.getItem(`result_${studentID}`);
  if (saved) {
    const data = JSON.parse(saved);
    loadResultFromData(data);
    document.getElementById('studentID').value = studentID;
  } else {
    alert('No result found for this Student ID.');
  }
}

function getCurrentResultData() {
  const data = {
    name: document.getElementById('resultName').value,
    admNo: document.getElementById('resultAdmNo').value,
    class: document.getElementById('resultClass').value,
    noInClass: document.getElementById('resultNoInClass').value,
    present: document.getElementById('resultPresent').value,
    absent: document.getElementById('resultAbsent').value,
    term: document.getElementById('termSelect').value,
    subjects: [],
    psycho: [document.getElementById('psycho1').value, document.getElementById('psycho2').value],
    affect: [document.getElementById('affect1').value, document.getElementById('affect2').value,
             document.getElementById('affect3').value, document.getElementById('affect4').value],
    comment: document.getElementById('teacherComment').value,
    position: document.getElementById('positionInClass').value,
    classAverage: document.getElementById('classAverage').value
  };
  document.querySelectorAll('#resultTable tbody tr').forEach(row => {
    const subjectSelect = row.cells[0].querySelector('select');
    const inputs = row.querySelectorAll('.score');
    data.subjects.push({
      subject: subjectSelect.value,
      ca1: inputs[0].value,
      ca2: inputs[1].value,
      hw: inputs[2].value,
      exam: inputs[3].value
    });
  });
  return data;
}

function loadResultFromData(data) {
  document.getElementById('resultName').value = data.name || '';
  document.getElementById('resultAdmNo').value = data.admNo || '';
  document.getElementById('resultClass').value = data.class || '';
  document.getElementById('resultNoInClass').value = data.noInClass || '';
  document.getElementById('resultPresent').value = data.present || '';
  document.getElementById('resultAbsent').value = data.absent || '';
  document.getElementById('termSelect').value = data.term || '1st Term';
  document.getElementById('psycho1').value = data.psycho?.[0] || '';
  document.getElementById('psycho2').value = data.psycho?.[1] || '';
  document.getElementById('affect1').value = data.affect?.[0] || '';
  document.getElementById('affect2').value = data.affect?.[1] || '';
  document.getElementById('affect3').value = data.affect?.[2] || '';
  document.getElementById('affect4').value = data.affect?.[3] || '';
  document.getElementById('teacherComment').value = data.comment || '';
  document.getElementById('positionInClass').value = data.position || '';
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';
  (data.subjects || []).forEach(sub => {
    addSubjectRow(sub.subject, sub.ca1, sub.ca2, sub.hw, sub.exam);
  });
  if ((data.subjects || []).length === 0) addSubjectRow();
  calculateGrades();
  updateTermDisplay();
}

function addSubjectRow(subject='', ca1='', ca2='', hw='', exam='') {
  const tbody = document.getElementById('resultTable').querySelector('tbody');
  const tr = document.createElement('tr');
  let options = subjectsList.map(s => `<option value="${s}" ${s === subject ? 'selected' : ''}>${s}</option>`).join('');
  tr.innerHTML = `
    <td>
      <select class="subject-select">
        ${options}
      </select>
    </td>
    <td><input class="score" value="${ca1}" type="number" min="0" max="15"></td>
    <td><input class="score" value="${ca2}" type="number" min="0" max="15"></td>
    <td><input class="score" value="${hw}" type="number" min="0" max="10"></td>
    <td><input class="score" value="${exam}" type="number" min="0" max="60"></td>
    <td><input class="total" readonly></td>
    <td><select class="grade" readonly>
      <option>A+</option><option>A</option><option>B+</option><option>B</option>
      <option>C+</option><option>C</option><option>D</option><option>F</option>
    </select></td>
    <td><select class="remark">
      <option>Outstanding</option><option>Excellent</option><option>Very Good</option>
      <option>Good</option><option>Average</option><option>Fair</option><option>Fail</option>
    </select></td>
    <td><button onclick="removeSubject(this)" class="small-btn">Remove</button></td>
  `;
  tbody.appendChild(tr);
  tr.querySelectorAll('.score').forEach(inp => inp.addEventListener('input', calculateGrades));
  const remarkSelect = tr.querySelector('.remark');
  remarkSelect.addEventListener('change', function() {
    this.setAttribute('title', this.value);
  });
  calculateGrades();
}

function addSubject() {
  addSubjectRow();
}

function removeSubject(btn) {
  btn.closest('tr').remove();
  calculateGrades();
}

function calculateGrades() {
  let grandTotal = 0;
  let subjectCount = 0;
  document.querySelectorAll('#resultTable tbody tr').forEach(row => {
    const scores = row.querySelectorAll('.score');
    let total = 0;
    scores.forEach(s => total += Number(s.value) || 0);
    const totalField = row.querySelector('.total');
    const gradeSelect = row.querySelector('.grade');
    const remarkSelect = row.querySelector('.remark');
    totalField.value = total;
    grandTotal += total;
    subjectCount++;
    const grade = getGrade(total);
    gradeSelect.value = grade;
    const remark = getRemark(total);
    remarkSelect.value = remark;
    remarkSelect.setAttribute('title', remark);
  });
  const avg = subjectCount > 0 ? (grandTotal / subjectCount).toFixed(2) : 0;
  document.getElementById('grandTotal').value = grandTotal;
  document.getElementById('classAverage').value = avg;
  document.getElementById('totalScoreDisplay').textContent = grandTotal;
  document.getElementById('averageDisplay').textContent = avg;
  document.getElementById('totalPossible').textContent = subjectCount * 100;
  const noInClass = parseInt(document.getElementById('resultNoInClass').value) || 1;
  const position = Math.round((1 - (avg / 100)) * (noInClass - 1)) + 1;
  const suffix = position === 1 ? 'st' : position === 2 ? 'nd' : position === 3 ? 'rd' : 'th';
  document.getElementById('positionInClass').value = position + suffix;
}

function getGrade(score) {
  if (score >= 95) return 'A+';
  if (score >= 90) return 'A';
  if (score >= 85) return 'B+';
  if (score >= 75) return 'B';
  if (score >= 70) return 'C+';
  if (score >= 60) return 'C';
  if (score >= 50) return 'D';
  return 'F';
}

function getRemark(score) {
  if (score >= 95) return 'Outstanding';
  if (score >= 90) return 'Excellent';
  if (score >= 85) return 'Very Good';
  if (score >= 75) return 'Good';
  if (score >= 60) return 'Average';
  if (score >= 50) return 'Fair';
  return 'Fail';
}

function clearImage(e, container, storageKey) {
  if (e) {
    e.stopPropagation();
    e.preventDefault();
  }
  if (typeof container === 'string') {
    container = document.querySelector('.' + container) || container;
  }
  const span = container.querySelector('span');
  const img = container.querySelector('img');
  if (span) span.style.display = 'block';
  if (img) img.remove();
  localStorage.removeItem(storageKey);
}

function previewLogo(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const container = document.querySelector('.school-logo');
      let img = container.querySelector('img');
      if (!img) {
        img = document.createElement('img');
        container.appendChild(img);
      }
      img.src = e.target.result;
      container.querySelector('span').style.display = 'none';
      localStorage.setItem(STORAGE_KEY_LOGO, e.target.result);
    }
    reader.readAsDataURL(file);
  }
}

function previewSignature(event, input) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const container = input.previousElementSibling;
      let img = container.querySelector('img');
      if (!img) {
        img = document.createElement('img');
        container.appendChild(img);
      }
      img.src = e.target.result;
      container.querySelector('span').style.display = 'none';
      const storageKey = container === document.querySelector('.footer > div:first-child .signature-upload')
        ? STORAGE_KEY_SIG_CLASS
        : STORAGE_KEY_SIG_HEAD;
      localStorage.setItem(storageKey, e.target.result);
    }
    reader.readAsDataURL(file);
  }
}

function loadImages() {
  const logoData = localStorage.getItem(STORAGE_KEY_LOGO);
  if (logoData) {
    const container = document.querySelector('.school-logo');
    let img = container.querySelector('img');
    if (!img) {
      img = document.createElement('img');
      container.appendChild(img);
    }
    img.src = logoData;
    container.querySelector('span').style.display = 'none';
  }
  const classSigData = localStorage.getItem(STORAGE_KEY_SIG_CLASS);
  if (classSigData) {
    const container = document.querySelector('.footer > div:first-child .signature-upload');
    let img = container.querySelector('img');
    if (!img) {
      img = document.createElement('img');
      container.appendChild(img);
    }
    img.src = classSigData;
    container.querySelector('span').style.display = 'none';
  }
  const headSigData = localStorage.getItem(STORAGE_KEY_SIG_HEAD);
  if (headSigData) {
    const container = document.querySelector('.footer > div:last-child .signature-upload');
    let img = container.querySelector('img');
    if (!img) {
      img = document.createElement('img');
      container.appendChild(img);
    }
    img.src = headSigData;
    container.querySelector('span').style.display = 'none';
  }
}

// Initialize
loadImages();
loadSchoolHeader();
addSubjectRow();
calculateGrades();
updateTermDisplay();
startAutoSave();
</script>
</body>
</html>
